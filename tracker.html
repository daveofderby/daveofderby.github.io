<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Leaflet Story Walk</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
      #map {
        height: 50vh;
        width: 100%;
      }
      html,
      body,
      #popup,
      #overlay {
        margin: 0;
        padding: 0;
        border: 0;
        font-family: Arial, sans-serif;
      }
      #popup {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        /* transform: translate(-50%, -50%); */
        background: white;
        padding: 20px;
        z-index: 9999;
        width: 99%;
        /* border-radius: 8px; */
        text-align: center;
      }
      #overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9998;
      }
    </style>
  </head>
  <body>
    <div id="map">Map</div>
    <div id="info"></div>
    <div id="overlay">Overlay</div>
    <div id="popup">
      <p id="popup-message"></p>
      <button id="close-popup">Close</button>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
      // ✅ Story locations
      const presetLocations = [
        { name: "London", lat: 51.5074, lng: -0.1278 },
        { name: "New York", lat: 40.7128, lng: -74.006 },
        { name: "Los Angeles", lat: 34.0522, lng: -118.2437 },
        { name: "Chicago", lat: 41.8781, lng: -87.6298 },
        { name: "Houston", lat: 29.7604, lng: -95.3698 },
        { name: "Paris", lat: 48.8566, lng: 2.3522 },
        { name: "Tokyo", lat: 35.6895, lng: 139.6917 },
        { name: "Sydney", lat: -33.8688, lng: 151.2093 },
        { name: "Rio de Janeiro", lat: -22.9068, lng: -43.1729 },
        { name: "Cairo", lat: 30.0444, lng: 31.2357 },
      ];

      let currentIndex = 0;
      let reached = false;
      let routeLine = null;

      const R = 6371e3; // Earth radius in meters

      function getDistance(lat1, lng1, lat2, lng2) {
        const toRad = (x) => (x * Math.PI) / 180;
        const φ1 = toRad(lat1);
        const φ2 = toRad(lat2);
        const Δφ = toRad(lat2 - lat1);
        const Δλ = toRad(lng2 - lng1);

        const a = Math.sin(Δφ / 2) ** 2 + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) ** 2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      function showPopup(message) {
        document.getElementById("popup-message").textContent = message;
        document.getElementById("overlay").style.display = "block";
        document.getElementById("popup").style.display = "block";
      }

      function hidePopup() {
        document.getElementById("overlay").style.display = "none";
        document.getElementById("popup").style.display = "none";
      }

      // Icons
      const tickIcon = L.icon({
        iconUrl: "https://cdn-icons-png.flaticon.com/512/190/190411.png", // green check
        iconSize: [15, 15],
      });

      const userIcon = L.icon({
        iconUrl: "icon-man.png",
        iconSize: [30, 30],
        iconAnchor: [15, 25],
        zIndexOffset: 1000,
      });

      const targetIcon = L.icon({
        iconUrl: "icon-page.png",
        iconSize: [24, 30],
        iconAnchor: [12, 25],
      });

      let nextMarker;

      document.getElementById("close-popup").addEventListener("click", () => {
        hidePopup();
        reached = false;
        currentIndex++;
        if (currentIndex < presetLocations.length) {
          // Add next target marker
          nextMarker = L.marker([presetLocations[currentIndex].lat, presetLocations[currentIndex].lng], {
            icon: targetIcon,
          }).addTo(map);

          // Draw route
          if (routeLine) map.removeLayer(routeLine);
          routeLine = L.polyline([userMarker.getLatLng(), nextMarker.getLatLng()], {
            color: "blue",
            weight: 3,
            dashArray: "5, 10",
          }).addTo(map);
        } else {
          if (routeLine) map.removeLayer(routeLine);
          alert("🎉 The story is complete!");
          redirectToHome();
        }
      });

      // Initialize map
      const map = L.map("map").setView([presetLocations[0].lat, presetLocations[0].lng], 3);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      // ⚪ Add grey dots for all locations (no popup, just placeholders)
      presetLocations.forEach((loc) => {
        L.circleMarker([loc.lat, loc.lng], {
          radius: 4,
          color: "grey",
          fillColor: "lightgrey",
          fillOpacity: 0.6,
        }).addTo(map);
      });

      const userMarker = L.marker([presetLocations[0].lat, presetLocations[0].lng], { riseOnHover: true, opacity: 1, icon: userIcon }).addTo(map);

      console.log(userMarker.getLatLng());

      // 🎯 First target marker
      nextMarker = L.marker([presetLocations[currentIndex].lat, presetLocations[currentIndex].lng], {
        icon: targetIcon,
      }).addTo(map);

      // Initial route
      routeLine = L.polyline([userMarker.getLatLng(), nextMarker.getLatLng()], {
        color: "blue",
        weight: 2,
        dashArray: "5, 10",
      }).addTo(map);

      function showInfo(fromLat, fromLon, toLat, toLon, distance, bearing) {
        console.log(`Distance: ${distance.toFixed(0)} m`); // Distance in meters
        // console.log(`Initial Bearing: ${bearing.toFixed(0)}°`); // Initial bearing in degrees

        const info = document.querySelector("#info");
        // info.innerHTML = `<p>From: ${fromLat} / ${fromLon}</p><p>To: ${toLat} / ${toLon}</p><p>Distance: ${distance.toFixed(0)} m</p><p>Initial Bearing: ${bearing.toFixed(0)}°</p><p>Found Target: ${distance < 5 ? "True" : "False"}</p><p>Current Page: ${currentPage + 1}</p><h3>${geoStoryPages[currentPage].title}</h3>`;
        info.innerHTML = `<p>From: ${fromLat} / ${fromLon}</p><p>To: ${toLat} / ${toLon}</p><p>Distance: ${distance.toFixed(0)} m</p>`;
      }

      // 📍 Track user location
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
          (pos) => {
            const { latitude, longitude } = pos.coords;

            console.log(pos.coords);

            // Update blue dot
            userMarker.setLatLng([latitude, longitude]);
            map.panTo([latitude, longitude]);

            // Update route dynamically
            if (routeLine && nextMarker) {
              routeLine.setLatLngs([userMarker.getLatLng(), nextMarker.getLatLng()]);
            }

            // Check distance to next location
            if (currentIndex < presetLocations.length && !reached) {
              const target = presetLocations[currentIndex];
              const dist = getDistance(latitude, longitude, target.lat, target.lng);
              showInfo(latitude, longitude, target.lat, target.lng, dist);
              if (dist <= 5) {
                reached = true;
                nextMarker.setIcon(tickIcon);

                // Remove route
                if (routeLine) {
                  map.removeLayer(routeLine);
                  routeLine = null;
                }

                // Show popup with story text
                showPopup(target.name);
              }
            }
          },
          (err) => console.error(err),
          { enableHighAccuracy: true, maximumAge: 1000, timeout: 5000 }
        );
      } else {
        alert("Geolocation not supported.");
      }
    </script>
  </body>
</html>
