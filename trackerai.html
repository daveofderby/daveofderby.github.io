<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Sequential Location Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      .popup {
        display: none;
        position: fixed;
        z-index: 999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.6);
      }

      .popup-content {
        background-color: #fff;
        margin: 15% auto;
        padding: 20px 30px;
        border-radius: 10px;
        width: 300px;
        text-align: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        position: relative;
      }

      .close-btn {
        position: absolute;
        right: 15px;
        top: 10px;
        font-size: 20px;
        cursor: pointer;
      }

      .popup-content button {
        margin-top: 15px;
        padding: 10px 20px;
        background-color: #28a745;
        border: none;
        color: white;
        font-size: 16px;
        border-radius: 5px;
        cursor: pointer;
      }

      .popup-content button:hover {
        background-color: #218838;
      }
    </style>
  </head>
  <body>
    <h2>üõ∞Ô∏è Sequential Location Tracking</h2>
    <p>Location tracking will move through locations in order.</p>

    <!-- Popup Modal -->
    <div id="locationPopup" class="popup">
      <div class="popup-content">
        <span class="close-btn" onclick="closePopup()">&times;</span>
        <p id="popupMessage">You've reached a location!</p>
        <button id="nextLocationBtn">Next Location</button>
      </div>
    </div>

    <script>
      // Ordered list of locations
      const targetLocations = [
        { name: "Location A", latitude: 40.7128, longitude: -74.006 }, // NYC
        { name: "Location B", latitude: 34.0522, longitude: -118.2437 }, // LA
        { name: "Location C", latitude: 51.5074, longitude: -0.1278 }, // London
      ];

      const MATCH_RADIUS_METERS = 100;
      let currentIndex = 0;
      let monitoringEnabled = true;

      function getDistanceInMeters(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const œÜ1 = (lat1 * Math.PI) / 180;
        const œÜ2 = (lat2 * Math.PI) / 180;
        const ŒîœÜ = ((lat2 - lat1) * Math.PI) / 180;
        const ŒîŒª = ((lon2 - lon1) * Math.PI) / 180;

        const a =
          Math.sin(ŒîœÜ / 2) ** 2 +
          Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) ** 2;

        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      function showPopup(message) {
        const popup = document.getElementById("locationPopup");
        const popupMsg = document.getElementById("popupMessage");
        popupMsg.textContent = message;
        popup.style.display = "block";
      }

      function closePopup() {
        document.getElementById("locationPopup").style.display = "none";
      }

      function checkCurrentLocation(currentLat, currentLng) {
        if (!monitoringEnabled || currentIndex >= targetLocations.length)
          return;

        const location = targetLocations[currentIndex];
        const distance = getDistanceInMeters(
          currentLat,
          currentLng,
          location.latitude,
          location.longitude
        );

        console.log(
          `Checking ${location.name}: ${distance.toFixed(2)} meters away`
        );

        if (distance <= MATCH_RADIUS_METERS) {
          monitoringEnabled = false; // stop checking until user clicks "Next"
          showPopup(`üéâ You've arrived at ${location.name}!`);
        }
      }

      function startLocationMonitoring() {
        if (!navigator.geolocation) {
          alert("Geolocation is not supported by your browser.");
          return;
        }

        navigator.geolocation.watchPosition(
          (position) => {
            const { latitude, longitude } = position.coords;
            console.log(`üìç Current: ${latitude}, ${longitude}`);
            checkCurrentLocation(latitude, longitude);
          },
          (error) => {
            console.error("Geolocation error:", error.message);
            alert("Error getting location: " + error.message);
          },
          {
            enableHighAccuracy: true,
            maximumAge: 10000,
            timeout: 5000,
          }
        );
      }

      document
        .getElementById("nextLocationBtn")
        .addEventListener("click", () => {
          closePopup();
          currentIndex++;

          if (currentIndex >= targetLocations.length) {
            showPopup("‚úÖ You've completed all locations!");
            document.getElementById("nextLocationBtn").style.display = "none";
          } else {
            monitoringEnabled = true; // resume monitoring
          }
        });

      // Start on load
      window.onload = startLocationMonitoring;
    </script>
  </body>
</html>
