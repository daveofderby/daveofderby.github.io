<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Leaflet Story Walk</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
      #map {
        height: 50vh;
        width: 100%;
      }
      html,
      body {
        margin: 0;
        padding: 0;
      }
      #popup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border: 2px solid #333;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        z-index: 9999;
        max-width: 300px;
        text-align: center;
      }
      #overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9998;
      }
    </style>
  </head>
  <body>
    <div id="map">Map</div>

    <div id="overlay">Overlay</div>
    <div id="popup">
      <p id="popup-message"></p>
      <button id="close-popup">Close</button>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
      // ✅ Story locations
      const presetLocations = [
        { lat: 52.89008, lng: -1.502809, name: "The Blagreaves Fox" },
        { lat: 52.8902, lng: -1.502752, name: "Once upon a time there was a fox" },
        { lat: 52.890486, lng: -1.502613, name: "Who was very fond of chilli" },
        { lat: 52.89008, lng: -1.502809, name: "but if he couldn't eat chilli, he ate cats!" },
      ];

      let currentIndex = 0;
      let reached = false;
      let routeLine = null;

      const R = 6371e3; // Earth radius in meters

      function getDistance(lat1, lng1, lat2, lng2) {
        const toRad = (x) => (x * Math.PI) / 180;
        const φ1 = toRad(lat1);
        const φ2 = toRad(lat2);
        const Δφ = toRad(lat2 - lat1);
        const Δλ = toRad(lng2 - lng1);

        const a = Math.sin(Δφ / 2) ** 2 + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) ** 2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      function showPopup(message) {
        document.getElementById("popup-message").textContent = message;
        document.getElementById("overlay").style.display = "block";
        document.getElementById("popup").style.display = "block";
      }

      function hidePopup() {
        document.getElementById("overlay").style.display = "none";
        document.getElementById("popup").style.display = "none";
      }

      // Icons
      const targetIcon = L.icon({
        iconUrl: "https://cdn-icons-png.flaticon.com/512/684/684908.png", // pin
        iconSize: [32, 32],
      });

      const tickIcon = L.icon({
        iconUrl: "https://cdn-icons-png.flaticon.com/512/190/190411.png", // green check
        iconSize: [32, 32],
      });

      let nextMarker;

      document.getElementById("close-popup").addEventListener("click", () => {
        hidePopup();
        reached = false;
        currentIndex++;
        if (currentIndex < presetLocations.length) {
          // Add next target marker
          nextMarker = L.marker([presetLocations[currentIndex].lat, presetLocations[currentIndex].lng], {
            icon: targetIcon,
          }).addTo(map);

          // Draw route
          if (routeLine) map.removeLayer(routeLine);
          routeLine = L.polyline([userMarker.getLatLng(), nextMarker.getLatLng()], {
            color: "blue",
            weight: 3,
            dashArray: "5, 10",
          }).addTo(map);
        } else {
          if (routeLine) map.removeLayer(routeLine);
          alert("🎉 The story is complete!");
        }
      });

      // // 📍 Get initial location
      // let startPosition;

      // if (navigator.geolocation) {
      //   navigator.geolocation.getCurrentPosition(
      //     (pos) => {
      //       startPosition = pos.coords;
      //     },
      //     (err) => console.error(err),
      //     { enableHighAccuracy: true, maximumAge: 1000, timeout: 5000 }
      //   );
      // } else {
      //   alert("Geolocation not supported.");
      // }

      // Initialize map
      const map = L.map("map").setView([presetLocations[0].lat, presetLocations[0].lng], 20);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      // ⚪ Add grey dots for all locations (no popup, just placeholders)
      presetLocations.forEach((loc) => {
        L.circleMarker([loc.lat, loc.lng], {
          radius: 4,
          color: "grey",
          fillColor: "lightgrey",
          fillOpacity: 0.6,
        }).addTo(map);
      });

      // // 🔵 Blue dot for current position
      // let userMarker = L.circleMarker([presetLocations[0].lat, presetLocations[0].lng], {
      //   radius: 8,
      //   fillColor: "#007bff",
      //   color: "#fff",
      //   weight: 2,
      //   opacity: 1,
      //   fillOpacity: 0.9,
      // }).addTo(map);

      const userIcon = L.icon({
        iconUrl: "icon-man.png",
        iconSize: [30, 30],
        iconAnchor: [15, 25],
        zIndexOffset: 1000,
      });

      const userMarker = L.marker([presetLocations[0].lat, presetLocations[0].lng], { riseOnHover: true, opacity: 1, icon: userIcon }).addTo(map);

      // 🎯 First target marker
      nextMarker = L.marker([presetLocations[currentIndex].lat, presetLocations[currentIndex].lng], {
        icon: targetIcon,
      }).addTo(map);

      // Initial route
      routeLine = L.polyline([userMarker.getLatLng(), nextMarker.getLatLng()], {
        color: "blue",
        weight: 3,
        dashArray: "5, 10",
      }).addTo(map);

      // 📍 Track user location
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
          (pos) => {
            const { latitude, longitude } = pos.coords;

            console.log(pos.coords);

            // Update blue dot
            userMarker.setLatLng([latitude, longitude]);
            map.panTo([latitude, longitude]);

            // Update route dynamically
            if (routeLine && nextMarker) {
              routeLine.setLatLngs([userMarker.getLatLng(), nextMarker.getLatLng()]);
            }

            // Check distance to next location
            if (currentIndex < presetLocations.length && !reached) {
              const target = presetLocations[currentIndex];
              const dist = getDistance(latitude, longitude, target.lat, target.lng);
              if (dist <= 5) {
                reached = true;
                nextMarker.setIcon(tickIcon);

                // Remove route
                if (routeLine) {
                  map.removeLayer(routeLine);
                  routeLine = null;
                }

                // Show popup with story text
                showPopup(target.name);
              }
            }
          },
          (err) => console.error(err),
          { enableHighAccuracy: true, maximumAge: 1000, timeout: 5000 }
        );
      } else {
        alert("Geolocation not supported.");
      }
    </script>
  </body>
</html>
